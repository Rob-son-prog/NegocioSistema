<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acesso do cliente</title>
  <link rel="stylesheet" href="style.css?v=6" />
</head>
<body class="dashboard">
  <div class="content" style="max-width:420px;margin:40px auto">
    <h2>Portal do cliente</h2>
    <p class="muted">Digite seu CPF para acessar seus boletos/parcelas.</p>

    <form id="formLogin" class="card" style="padding:16px;display:grid;gap:12px;">
      <label>CPF
        <input id="cpf" inputmode="numeric" autocomplete="username" placeholder="000.000.000-00" required />
      </label>
      <button id="btn" class="btn primary" type="submit">Entrar</button>
      <p id="out" class="muted"></p>
    </form>
  </div>

  <!-- SEMPRE primeiro -->
  <script src="config.js?v=3"></script>

  <script>
  (function(){
    // Usa a base vinda do config; em produção será mesma origem ("")
    const API =
      (window.APP_CONFIG && window.APP_CONFIG.API_URL !== undefined)
        ? window.APP_CONFIG.API_URL
        : (location.hostname.endsWith('.onrender.com') ? '' : 'http://127.0.0.1:4000');

    const TOKEN_KEY = 'client_token';

    // Se já tem sessão, vai direto
    const already = localStorage.getItem(TOKEN_KEY);
    if (already) { location.href = 'portal.html'; return; }

    const form = document.getElementById('formLogin');
    const cpfEl = document.getElementById('cpf');
    const out = document.getElementById('out');
    const btn = document.getElementById('btn');

    // máscara simples de CPF
    cpfEl.addEventListener('input', ()=>{
      let v = cpfEl.value.replace(/\D/g,'').slice(0,11);
      v = v.replace(/(\d{3})(\d)/,'$1.$2')
           .replace(/(\d{3})(\d)/,'$1.$2')
           .replace(/(\d{3})(\d{1,2})$/,'$1-$2');
      cpfEl.value = v;
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      out.textContent = '';
      const cpf = cpfEl.value.replace(/\D/g,'');
      if (cpf.length !== 11){ out.textContent = 'CPF inválido.'; return; }

      btn.disabled = true;
      try{
        const res = await fetch(API + '/api/client/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cpf })
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = {}; }

        if (!res.ok){
          out.textContent = data?.error || `Falha no login (HTTP ${res.status})`;
          btn.disabled = false;
          return;
        }

        localStorage.setItem(TOKEN_KEY, data.token || '');
        if (data.customer) {
          localStorage.setItem('client_name', data.customer.name || '');
          localStorage.setItem('client_id', String(data.customer.id || ''));
        }
        location.href = 'portal.html';
      }catch(err){
        out.textContent = 'Erro: ' + (err?.message || 'Falha de conexão');
        console.error('LOGIN ERRO', err);
      }finally{
        btn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>
